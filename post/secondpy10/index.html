<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>それからのPython 10  &middot; Kujira, Civ4 Mod Blog</title>
    


<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5V7SPDZ');</script>




    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="それからのPython, 講座, ">


<meta property="og:title" content="それからのPython 10  &middot; Kujira, Civ4 Mod Blog ">
<meta property="og:site_name" content="Kujira, Civ4 Mod Blog"/>
<meta property="og:url" content="https://gforestshade.github.io/kujira/post/secondpy10/" />
<meta property="og:locale" content="ja-JP">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2017-12-30T12:04:00Z" />
<meta property="og:article:modified_time" content="2017-12-30T12:04:00Z" />

  
    
<meta property="og:article:tag" content="それからのPython">
    
<meta property="og:article:tag" content="講座">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="それからのPython 10" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="https://gforestshade.github.io/kujira/post/secondpy10/" />
<meta name="twitter:domain" content="https://gforestshade.github.io/kujira/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "それからのPython 10",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2017-12-30",
    "description": "",
    "wordCount":  4188 
  }
</script>




<link rel="canonical" href="https://gforestshade.github.io/kujira/post/secondpy10/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://gforestshade.github.io/touch-icon-144-precomposed.png">
<link href="https://gforestshade.github.io/favicon.ico" rel="icon">

<meta name="generator" content="Hugo 0.101.0" />

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous" />
<link href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.0/materia/bootstrap.min.css" rel="stylesheet" integrity="sha384-BJWCnw/x/9+kQsLGLQDoCX2oJg7j1LjkOfPZWtUPTJ0tn00hYIB5r9u7KnGJxFnY" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night-eighties.min.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

<link rel="stylesheet" href="https://gforestshade.github.io/kujira/css/style.css" />


    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    </head>

    <body id="index" class="archive">
      


<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5V7SPDZ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>




      <nav class="navbar navbar-expand-md navbar-dark px-5 navbar-color">
        <a class="navbar-brand" href="https://gforestshade.github.io/kujira/">Kujira, Civ4 Mod Blog</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false"
                aria-label="Toggle navigation">
          &#9776;
        </button>
        <div class="mx-md-4"></div>
        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="nav navbar-nav">
            
            
              <a class="nav-item nav-link menu-item mx-md-2" href="https://gforestshade.github.io/kujira/post/hajimeni/">
              <i class='fa fa-star'></i>
              <span>はじめに</span>
              </a>
            
              <a class="nav-item nav-link menu-item mx-md-2" href="https://gforestshade.github.io/kujira/page/license/">
              <i class='fa fa-file'></i>
              <span>LICENSE</span>
              </a>
            
          </div>
        </div>
      </nav>
      <div class="m-3"></div>

<div id="whole">
  <div class="leftbar">
    




<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a class="collapsed" data-toggle="collapse" href="#collist_0" role="button">目次</a></h5>
  </div>
  <div role="tabpanel" id="collist_0" class="collapse show">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/hajimeni/">はじめに</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a class="collapsed" data-toggle="collapse" href="#collist_1" role="button">Python</a></h5>
  </div>
  <div role="tabpanel" id="collist_1" class="collapse show">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted1/">はじめてのPythonMOD 1</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted2/">はじめてのPythonMOD 2</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted3/">はじめてのPythonMOD 3</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted4/">はじめてのPythonMOD 4</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted5/">はじめてのPythonMOD 5</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted6/">はじめてのPythonMOD 6</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted7/">はじめてのPythonMOD 7</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy1/">それからのPython 1</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy2/">それからのPython 2</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy3/">それからのPython 3</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy4/">それからのPython 4</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy5/">それからのPython 5</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy6/">それからのPython 6</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy7/">それからのPython 7</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy8/">それからのPython 8</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy9/">それからのPython 9</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy10/">それからのPython 10</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a data-toggle="collapse" href="#collist_2" role="button">XML</a></h5>
  </div>
  <div role="tabpanel" id="collist_2" class="collapse">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4unitinfos/">CIV4UnitInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4unitclassinfos/">CIV4UnitClassInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4buildinginfos/">CIV4BuildingInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/keyichiran/">XMLキー一覧_new</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4leaderheadinfos/">CIV4LeaderHeadInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4civilizationinfos/">Civ4CivilizationInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4civicinfos/">Civ4CivicInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/glossary/">用語集</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4techinfos/">Civ4TechInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4traitinfos/">Civ4TraitInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4buildingclassinfos/">CIV4BuildingClassInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4promotioninfos/">CIV4PromotionInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4projectinfos/">CIV4ProjectInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4handicapinfo/">CIV4HandicapInfo.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4bonusinfos/">CIV4BonusInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4improvementinfos/">CIV4ImprovementInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4gamespeedinfo/">CIV4GameSpeedInfo.xml</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a data-toggle="collapse" href="#collist_3" role="button">C&#43;&#43;</a></h5>
  </div>
  <div role="tabpanel" id="collist_3" class="collapse">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/howtocompile/">CvGameCoreDll.dllの作り方(2018-02)</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/howtocompiledoc/">CvGameCoreDll.dllの作り方(2018-05)</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a data-toggle="collapse" href="#collist_4" role="button">コラム</a></h5>
  </div>
  <div role="tabpanel" id="collist_4" class="collapse">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/power/">通常電力、きたない電力</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/movement/">移動力と地形コスト</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/irrigation/">灌漑</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a data-toggle="collapse" href="#collist_5" role="button">MMD_to_CIV4</a></h5>
  </div>
  <div role="tabpanel" id="collist_5" class="collapse">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/mmd_to_nif/">MMDモデルをCiv4に登場させたい</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/nifanimation/">MMDモデルをCiv4上で動かしたい</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



 







  </div>
  <div class="centerbar">
    <div class="container-fluid">
            <div class="card card-body my-3">
        <div class="article-title">
          

  
    
    
      
    
      
    
      
          <a href="https://gforestshade.github.io/kujira/post/secondpy10/" itemprop="url">
            <img src="https://gforestshade.github.io/kujira/banner/photo_pink1_1024x200.png" class="img-fluid border rounded" alt="Generic responsive image">
          </a>
          
            <p class="banner-license">banner: <a href="https://www.flickr.com/photos/135366503@N05/31176873090/">&lsquo;I love nature and nature loves me &hellip;..&rsquo; by CLAUDIA DEA</a> (トリミング) under a <a href="https://creativecommons.org/licenses/by/2.0/deed.ja">Creative Commons Attribution 2.0</a>.</p>
          
      
    
      
    
      
    
  
  <div class="py-3" ></div>


          <h1 class="article-title">それからのPython 10</h1>
        </div>
        <div class="article-info text-muted d-flex flex-wrap align-items-center align-items-end flex-row justify-content-end mt-1 mb-3">
          <p><time datetime="2017-12-30">2017-12-30 12:04</time></p>
          
          <p>4188  Words</p>
          
          

          
          <p>
            カテゴリ：
            
            <a class="btn btn-sm btn-outline-primary" href="https://gforestshade.github.io/kujira/categories/python">Python</a>
            
          </p>
          

          
          <p>
            タグ：
            
            <a class="btn btn-sm btn-outline-info" href="https://gforestshade.github.io/kujira/tags/%e3%81%9d%e3%82%8c%e3%81%8b%e3%82%89%e3%81%aepython">それからのPython</a>
            
            <a class="btn btn-sm btn-outline-info" href="https://gforestshade.github.io/kujira/tags/%e8%ac%9b%e5%ba%a7">講座</a>
            
          </p>
          
        </div>
        <div class="article">
          <h1 id="はじめに">はじめに</h1>
<ul>
<li><a href="https://gforestshade.github.io/kujira/post/secondpy9/">その９</a>のつづき</li>
<li>簡単なスペルの仕組みをつくってみる</li>
<li>４部作のうちの４回目</li>
<li>ついに各スペルの実装へ</li>
</ul>
<h1 id="湧き水">湧き水</h1>
<p>お待たせしました！個別のスペル処理です。まず湧き水を見てみましょう。</p>
<pre tabindex="0"><code>class SpellWater(Spell):
    &#34;&#34;&#34;湧き水&#34;&#34;&#34;
    
    def execute(self):
        &#34;&#34;&#34;
        直下のタイルが自チームの砂漠なら平原に変化させる
        &#34;&#34;&#34;

        caster_plot = self._caster.plot()
        DESERT = git(&#34;TERRAIN_DESERT&#34;)
        PLAINS = git(&#34;TERRAIN_PLAINS&#34;)
        
        if caster_plot.getTeam() == self._caster.getTeam() and caster_plot.getTerrainType() == DESERT:
            caster_plot.setTerrainType(PLAINS, True, True)
            return True
            

# スペル一覧に追加
SpellInfo.spells.append(SpellInfo(&#34;SPELL_WATER&#34;, SpellWater))
</code></pre><p><code>class SpellWater(Spell):</code>で、Spellというクラスをベースにして<br>
SpellWaterというクラスをつくっています。<br>
これは継承という仕組みを用いています。<br>
継承について詳しく知りたい方は、<a href="https://gforestshade.github.io/kujira/post/secondpy_ex2/">付録</a>を参照してください。<br>
ざっくりいうと、さきほどの共通処理に加えて、<br>
いまから個別処理を書きますよ、と宣言しています。</p>
<p>先ほど空呼びしていた<code>execute()</code>を実際に書いています。</p>
<p><code>caster_plot.getTeam() == self._caster.getTeam()</code>で<br>
詠唱者がいま立っているPlotのチームと、詠唱者自身の所属チームを比較しています。<br>
右辺はわかりやすいと思いますが、<br>
左辺は「詠唱者がいま立っているタイルは誰の領土か」ということを表しています。<br>
左辺のチームと右辺のチームが同じであるということは、<br>
「詠唱者がいま立っているタイルは詠唱者自身の所属チームの領土である」、<br>
つまり「詠唱者は自領土のタイルの上にいる」ということを表します。</p>
<p><code>caster_plot.getTerrainType() == DESERT</code>で<br>
さらにそのタイルの地形idと砂漠のidとを比較しています。<br>
「そのタイルが砂漠である」ことを表していますね。</p>
<p><code>and</code>でその両方を満たすならば、<br>
<code>caster_plot.setTerrainType(PLAINS, True, True)</code><br>
地形を平原のidに設定します。<br>
そしてこの場合、スペルは成功したことになりますから、<br>
<code>return True</code>で、共通処理の方に「エフェクト再生してもいいよ」と伝えます。</p>
<p>両方を満たすというわけではない場合、<br>
そのまま<code>return</code>を迎えないままでメソッドが終了しています。<br>
こういった場合、戻り値として<code>None</code>という値が呼び出し元に帰ります。<br>
これは偽扱いになりますので、それを受け取った<code>cast()</code>はエフェクトを再生しません。<br>
ただ、昇進を取ったことをなかったことにするわけではないので、<br>
ただの無駄撃ちになります。これは<a href="https://gforestshade.github.io/kujira/post/secondpy7/#%E8%A8%AD%E8%A8%88%E3%81%97%E3%82%88%E3%81%86">設計</a>のときに定めた通りです。</p>
<p>そして最後に<em><strong>クラス外で</strong></em>、<br>
<code>SpellInfo.spells.append(SpellInfo(&quot;SPELL_WATER&quot;, SpellWater))</code><br>
という文を実行しています。<br>
まず<code>SpellInfo(&quot;SPELL_WATER&quot;, SpellWater)</code>の部分で<br>
SpellInfoインスタンスを作成しています。<br>
SpellInfoインスタンスは「名前」と「クラスオブジェクト」を保持するのでした。<br>
<code>&quot;SPELL_WATER&quot;</code>と<code>SpellWater</code>クラスをここで指定しています。</p>
<p>このSpellInfoインスタンスを、<code>SpellInfo.spells</code>というリストに<br>
(クラス変数なのでした)<code>append()</code>しています。<br>
これで、気分としては「&ldquo;SPELL_WATER&quot;という名前で、<br>
SpellWaterクラスに個別処理が書いてある、そういうスペルがあるよ」<br>
と登録したような感じになります。</p>
<p>クラス外にこの処理を書くことにより、<br>
処理はこのファイル(KujiraEventManager.py)が最初に読み込まれたとき<br>
(おそらくCiv4の起動時)に実行されます。<br>
Infoに登録する情報を名前とクラスだけに絞ったのもこのためです。<br>
ゲームが始まっていなくてもInfoだけは読み込まれるようになります。<br>
今回はやりませんが、スペルの情報もCivilopediaに載せたいと思ったときに<br>
このことが重要になってきます。<br>
Civilipediaはゲームの状況とは関係なく開けるからです。</p>
<p>これで、湧き水の処理とスペル一覧への登録ができました。</p>
<h1 id="毒散布">毒散布</h1>
<p>土台をある程度ちゃんと書いたおかげで、<br>
コピペは最小限で済ませつつ、スペルを増やせるようになっています。<br>
毒散布を見てみましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpellPoison</span>(Spell):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;毒散布&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        周囲1マスの敵対ユニットに『毒』を与える
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        POISONED <span style="color:#f92672">=</span> git(<span style="color:#e6db74">&#34;PROMOTION_POISONED&#34;</span>)
</span></span><span style="display:flex;"><span>        units <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>selectEnemyUnits(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> unit <span style="color:#f92672">in</span> units:
</span></span><span style="display:flex;"><span>            unit<span style="color:#f92672">.</span>setHasPromotion(POISONED, <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SpellInfo<span style="color:#f92672">.</span>spells<span style="color:#f92672">.</span>append(SpellInfo(<span style="color:#e6db74">&#34;SPELL_POISON&#34;</span>, SpellPoison))
</span></span></code></pre></div><p>湧き水と同様、Spellを継承して<code>execute()</code>の中に個別処理を書いていきます。<br>
共通処理に書いてあるので、<code>units = self.selectEnemyUnits(1)</code>とするだけで<br>
1マス圏内にいる敵対ユニットのリストが取れてきます。<br>
(よく使う共通処理に名前が付けられる、一度書けば呼び出すだけでいい、など、関数の利点なのでした)</p>
<p>ですから、あとは<code>units</code>の中の各ユニットに対して<br>
<code>unit.setHasPromotion(POISONED, True)</code>で昇進を付与するだけです。<br>
あらかじめ<code>POISONED = git(&quot;PROMOTION_POISONED&quot;)</code>としたことで<br>
<code>POISONED</code>の値は&quot;PROMOTION_POISONED&quot;の昇進idになっていますね。</p>
<p>そしてスペル一覧に登録します。名前は&quot;SPELL_POISON&quot;にしましょう。<br>
これで&quot;PROMOTION_&ldquo;を頭につけたとき、&ldquo;PROMOTION_SPELL_POISON&quot;になるはずです。<br>
発動用の昇進と同じ名前になりますね。</p>
<h1 id="火炎幕">火炎幕</h1>
<p>どんどん追加していきます。火炎幕です。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpellFire</span>(Spell):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;火炎幕&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        周囲1マスの敵対ユニットに10%のダメージを与える
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        最大40%まで
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        i_damage <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        max_damage <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>        caster_owner <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_caster<span style="color:#f92672">.</span>getOwner()
</span></span><span style="display:flex;"><span>        units <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>selectEnemyUnits(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> unit <span style="color:#f92672">in</span> units:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> unit<span style="color:#f92672">.</span>getDamage() <span style="color:#f92672">&gt;=</span> max_damage:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            damage <span style="color:#f92672">=</span> min(unit<span style="color:#f92672">.</span>getDamage() <span style="color:#f92672">+</span> i_damage, max_damage)
</span></span><span style="display:flex;"><span>            unit<span style="color:#f92672">.</span>setDamage(damage, caster_owner)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SpellInfo<span style="color:#f92672">.</span>spells<span style="color:#f92672">.</span>append(SpellInfo(<span style="color:#e6db74">&#34;SPELL_FIRE&#34;</span>, SpellFire))
</span></span></code></pre></div><p>さっきと対象は同じで周囲１マスの敵対ユニットです。<br>
今度は昇進付与ではなく<code>unit.setDamage(damage, caster_owner)</code>としています。</p>
<p>これは文字通りダメージ値を上書きさせるメソッドです。<br>
全てのユニットは(戦闘力とは別に)HPを持っていて、<br>
最大HPは戦闘力にかかわらず100です。<br>
そしてHPが100から減っているユニットは、<br>
その割合に応じて戦闘力にペナルティを受けます。<br>
例えば歩兵(戦闘力20)のHPが40にまで減っているとき、<br>
その状態での戦闘力は 20 * 0.40 = 8 という計算になります。</p>
<p>しかし、Civ4内部表現ではHPという形ではなく、「ダメージ値」で表されています。<br>
といっても難しいものではなく、「ダメージ値」は<br>
100からどれくらいHPが減っているかを表す値です。<br>
ダメージ値が10のときは残りHP90、ダメージ値が50のときは残りHP50、<br>
ダメージ値が100に達するとHPがなくなってユニットは撃破された扱いになります。</p>
<p>今回はHPが6割を切らないようにしたいので、<br>
ダメージ値が40を超えないように、40を超える値でダメージ値を上書きしてしまわないようにします。<br>
そもそも現在のダメージ値が40以上になっているユニットは<code>continue</code>で飛ばします。<br>
その上で、現在ダメージ値に10を足したものを新しいダメージ値として上書きしたいのですが、<br>
このときも40を超えないように注意する必要があります。<br>
現在ダメージ値は状況によっては35や39かもしれないからです。<br>
そこで<code>min()</code>関数を使って40が上限になるように新しいダメージ値を得ます。<br>
(<code>min()</code>関数による上限設定については、<a href="https://gforestshade.github.io/kujira/post/secondpy_ex2/#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%B7%A1%E3%82%8A">付録</a>に詳しいです)<br>
そうして求めた値<code>damage</code>でダメージ値を上書きします。</p>
<p><code>setDamage()</code>には第１引数に新しいダメージ値、<br>
第２引数に「誰によるダメージか」をプレイヤーidで指定しなければなりません。<br>
あらかじめ詠唱者のオーナーのプレイヤーidを<br>
<code>caster_owner</code>に代入しておいて、それを指定しています。</p>
<p>忘れずにスペル一覧に登録します。名前は&quot;SPELL_FIRE&quot;にしましょう。<br>
&ldquo;PROMOTION_&ldquo;を頭につけたら&quot;PROMOTION_SPELL_FIRE&quot;になるはずです。<br>
発動用の昇進と同じ名前になります。</p>
<h1 id="昇進を取得したとき">昇進を取得したとき</h1>
<p>ここまでの壮大な前振りを経て、ついにスペルを発動させる部分です。<br>
昇進を取得したときのイベントを捕まえて、<br>
適切なクラスの<code>cast()</code>メソッドを呼び出します。見てみましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyEventManager</span>(CvEventManager<span style="color:#f92672">.</span>CvEventManager, object):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onUnitPromoted</span>(self, argsList):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Called when a unit is promoted&#39;</span>
</span></span><span style="display:flex;"><span>        super(self<span style="color:#f92672">.</span>__class__, self)<span style="color:#f92672">.</span>onUnitPromoted(argsList)
</span></span><span style="display:flex;"><span>        pUnit, iPromotion <span style="color:#f92672">=</span> argsList
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">##########</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> spellinfo <span style="color:#f92672">in</span> SpellInfo<span style="color:#f92672">.</span>spells:
</span></span><span style="display:flex;"><span>            iSpellPromo <span style="color:#f92672">=</span> git(spellinfo<span style="color:#f92672">.</span>getPromotionName())
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> iPromotion <span style="color:#f92672">==</span> iSpellPromo:
</span></span><span style="display:flex;"><span>                SpellClass <span style="color:#f92672">=</span> spellinfo<span style="color:#f92672">.</span>getSpellClass()
</span></span><span style="display:flex;"><span>                spell <span style="color:#f92672">=</span> SpellClass(pUnit)
</span></span><span style="display:flex;"><span>                spell<span style="color:#f92672">.</span>cast()
</span></span></code></pre></div><p><code>onUnitPromoted()</code>メソッドをオーバーライドします。<br>
引数情報は<code>pUnit</code>が昇進を取得したユニットのインスタンス、<br>
<code>iPromotion</code>が取得された昇進のidです。</p>
<p>そして、スペル一覧<code>SpellInfo.spells</code>をfor文で各要素巡回します。<br>
ここにはスペル1種類につき1つのSpellInfoインスタンスが登録されているのでした。<br>
つまり、<code>spellinfo</code>はなんらかのスペルのSpellInfoで、<br>
<code>spellinfo.getPromotionName()</code>とすれば<br>
そのスペルの(名前から生成した)昇進名が得られることになります。<br>
それをさらに<code>gc.getInfoTypeForString()</code>に通せば<br>
スペルに対応する昇進idが得られます。</p>
<p>もし、いまユニットが取得した昇進と、そのスペルの昇進名が一致すれば、<br>
ユニットの発動しようとしたスペルは正にそのスペルだと特定できたことになります。<br>
<code>spellinfo.getSpellClass()</code>からクラスオブジェクトを取得し、<br>
(このオブジェクトはSpellWater・SpellPoison・SpellFireのうちの<br>
いずれか１つ、昇進名からヒットしたものになっているはずです)<br>
そのクラスのインスタンスを作成します。</p>
<p>その際に詠唱者を引数として渡しましょう。<br>
これは共通部分のところでインスタンス変数として保存・活用されるのでした。<br>
最後に<code>cast()</code>を呼び出します。<br>
あとのことはここまで頑張って書いてきた共通処理が<code>execute()</code>を<br>
適切に呼び出して、適切にエフェクトを出したり出さなかったりしてくれるはずです。</p>
<h1 id="ためす">ためす</h1>
<p>というわけで、できました。お疲れさまでした。<br>
起動して遊んでみましょう。</p>
<h1 id="おわりに">おわりに</h1>
<p>これで「それからのPython」シリーズも終わりです。<br>
だいぶ基礎は見についてきましたが、まだまだいろいろなMODがあります。<br>
是非自分でも作ってみてください。</p>
        </div>
        <div class="col-12">
  
</div>

      </div>

    </div>
  </div>

<footer id="contentinfo" class="footer">
  <address id="about" class="vcard body ml-2">
     <a href="https://gforestshade.github.io/kujira/">Kujira, Civ4 Mod Blog</a>  &copy; 2022 gforest_shade; licenced by <a href="https://creativecommons.org/licenses/by/4.0/deed.ja">CC-BY-4.0</a>
  </address>
</footer>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>

