<!DOCTYPE html>
<html>
  <head>
    <title>はじめてのPythonMOD 1  &middot; Kujira, Civ4 Mod Blog</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="はじめてのPythonMOD, 講座, ">


<meta property="og:title" content="はじめてのPythonMOD 1  &middot; Kujira, Civ4 Mod Blog ">
<meta property="og:site_name" content="Kujira, Civ4 Mod Blog"/>
<meta property="og:url" content="https://gforestshade.github.io/kujira/post/getstarted1/" />
<meta property="og:locale" content="ja-JP">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2017-07-03T00:00:00Z" />
<meta property="og:article:modified_time" content="2017-07-03T00:00:00Z" />

  
    
<meta property="og:article:tag" content="はじめてのPythonMOD">
    
<meta property="og:article:tag" content="講座">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="はじめてのPythonMOD 1" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="https://gforestshade.github.io/kujira/post/getstarted1/" />
<meta name="twitter:domain" content="https://gforestshade.github.io/kujira/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "はじめてのPythonMOD 1",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2017-07-03",
    "description": "",
    "wordCount":  4502 
  }
</script>



<link rel="canonical" href="https://gforestshade.github.io/kujira/post/getstarted1/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://gforestshade.github.io/touch-icon-144-precomposed.png">
<link href="https://gforestshade.github.io/favicon.ico" rel="icon">

<meta name="generator" content="Hugo 0.62.2" />

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous" />
<link href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.0/materia/bootstrap.min.css" rel="stylesheet" integrity="sha384-BJWCnw/x/9+kQsLGLQDoCX2oJg7j1LjkOfPZWtUPTJ0tn00hYIB5r9u7KnGJxFnY" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night-eighties.min.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

<link rel="stylesheet" href="https://gforestshade.github.io/kujira/css/style.css" />


    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-111798374-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    </head>

    <body id="index" class="archive">
      <nav class="navbar navbar-expand-md navbar-dark px-5 navbar-color">
        <a class="navbar-brand" href="https://gforestshade.github.io/kujira/">Kujira, Civ4 Mod Blog</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false"
                aria-label="Toggle navigation">
          &#9776;
        </button>
        <div class="mx-md-4"></div>
        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="nav navbar-nav">
            
            
              <a class="nav-item nav-link menu-item mx-md-2" href="https://gforestshade.github.io/kujira/post/hajimeni/">
              <i class='fa fa-star'></i>
              <span>はじめに</span>
              </a>
            
              <a class="nav-item nav-link menu-item mx-md-2" href="https://gforestshade.github.io/kujira/page/license/">
              <i class='fa fa-file'></i>
              <span>LICENSE</span>
              </a>
            
          </div>
        </div>
      </nav>
      <div class="m-3"></div>

<div id="whole">
  <div class="leftbar">
    




<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a class="collapsed" data-toggle="collapse" href="#collist_0" role="button">目次</a></h5>
  </div>
  <div role="tabpanel" id="collist_0" class="collapse show">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/hajimeni/">はじめに</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a class="collapsed" data-toggle="collapse" href="#collist_1" role="button">Python</a></h5>
  </div>
  <div role="tabpanel" id="collist_1" class="collapse show">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted1/">はじめてのPythonMOD 1</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted2/">はじめてのPythonMOD 2</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted3/">はじめてのPythonMOD 3</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted4/">はじめてのPythonMOD 4</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted5/">はじめてのPythonMOD 5</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted6/">はじめてのPythonMOD 6</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/getstarted7/">はじめてのPythonMOD 7</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy1/">それからのPython 1</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy2/">それからのPython 2</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy3/">それからのPython 3</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy4/">それからのPython 4</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy5/">それからのPython 5</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy6/">それからのPython 6</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy7/">それからのPython 7</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy8/">それからのPython 8</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy9/">それからのPython 9</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/secondpy10/">それからのPython 10</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a data-toggle="collapse" href="#collist_2" role="button">XML</a></h5>
  </div>
  <div role="tabpanel" id="collist_2" class="collapse">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4unitinfos/">CIV4UnitInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4unitclassinfos/">CIV4UnitClassInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4buildinginfos/">CIV4BuildingInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/keyichiran/">XMLキー一覧_new</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4leaderheadinfos/">CIV4LeaderHeadInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4civilizationinfos/">Civ4CivilizationInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4civicinfos/">Civ4CivicInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/glossary/">用語集</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4techinfos/">Civ4TechInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4traitinfos/">Civ4TraitInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4buildingclassinfos/">CIV4BuildingClassInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4promotioninfos/">CIV4PromotionInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4projectinfos/">CIV4ProjectInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4handicapinfo/">CIV4HandicapInfo.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4bonusinfos/">CIV4BonusInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4improvementinfos/">CIV4ImprovementInfos.xml</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/civ4gamespeedinfo/">CIV4GameSpeedInfo.xml</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a data-toggle="collapse" href="#collist_3" role="button">C&#43;&#43;</a></h5>
  </div>
  <div role="tabpanel" id="collist_3" class="collapse">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/howtocompile/">CvGameCoreDll.dllの作り方(2018-02)</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/howtocompiledoc/">CvGameCoreDll.dllの作り方(2018-05)</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a data-toggle="collapse" href="#collist_4" role="button">コラム</a></h5>
  </div>
  <div role="tabpanel" id="collist_4" class="collapse">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/power/">通常電力、きたない電力</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/movement/">移動力と地形コスト</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/irrigation/">灌漑</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



<div class="card m-3">
  <div class="card-header" role="tab">
    
    <h5 class="mb-0"><a data-toggle="collapse" href="#collist_5" role="button">MMD_to_CIV4</a></h5>
  </div>
  <div role="tabpanel" id="collist_5" class="collapse">
    <div class="list-group list-group-flush">
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/mmd_to_nif/">MMDモデルをCiv4に登場させたい</a>
      
      <a class="list-group-item list-group-item-action" href="https://gforestshade.github.io/kujira/post/nifanimation/">MMDモデルをCiv4上で動かしたい</a>
      
    </div>
    <div class="card-footer p-2"></div>
  </div>
</div>



 







  </div>
  <div class="centerbar">
    <div class="container-fluid">
            <div class="card card-body my-3">
        <div class="article-title">
          

  
    
    
      
    
      
          <a href="https://gforestshade.github.io/kujira/post/getstarted1/" itemprop="url">
            <img src="https://gforestshade.github.io/kujira/banner/photo_yellow1_1024x200.jpg" class="img-fluid border rounded" alt="Generic responsive image">
          </a>
          
            <p class="banner-license">banner: <a href="https://www.flickr.com/photos/132803717@N02/27004253005/">&lsquo;Choice&rsquo; by Seán Mackey</a> (トリミング) under a <a href="https://creativecommons.org/licenses/by/2.0/deed.ja">Creative Commons Attribution 2.0</a>.</p>
          
      
    
      
    
      
    
      
    
  
  <div class="py-3" ></div>


          <h1 class="article-title">はじめてのPythonMOD 1</h1>
        </div>
        <div class="article-info text-muted d-flex flex-wrap align-items-center align-items-end flex-row justify-content-end mt-1 mb-3">
          <p><time datetime="2017-07-03">2017-07-03 00:00</time></p>
          
          <p>4502  Words</p>
          
          

          
          <p>
            カテゴリ：
            
            <a class="btn btn-sm btn-outline-primary" href="https://gforestshade.github.io/kujira/categories/python">Python</a>
            
          </p>
          

          
          <p>
            タグ：
            
            <a class="btn btn-sm btn-outline-info" href="https://gforestshade.github.io/kujira/tags/%e3%81%af%e3%81%98%e3%82%81%e3%81%a6%e3%81%aepythonmod">はじめてのPythonMOD</a>
            
            <a class="btn btn-sm btn-outline-info" href="https://gforestshade.github.io/kujira/tags/%e8%ac%9b%e5%ba%a7">講座</a>
            
          </p>
          
        </div>
        <div class="article">
          <h1 id="はじめに">はじめに</h1>
<h2 id="これは何か">これは何か</h2>
<p>これは、<br>
「PythonによるModding、やってみたいけどどこから手を付けたら&hellip;」<br>
という声にお応えして、CvEventManager.pyを編集して<br>
XMLだけではできないちょっと面白いことをやってみようという企画です。<br>
XMLで文明やユニットをいじったことがあればよりすんなり入り込めます。</p>
<h2 id="これは何でないか">これは何でないか</h2>
<p>これは、技術的な解説、PythonによるModdingに親しむ、<br>
という視点での説明に偏重しています。<br>
あなたが作りたいMODへの直接的なヒントやコピペですぐ動くコードは<br>
あまりないかもしれません。</p>
<h1 id="civilizationivini">CivilizationIV.ini</h1>
<p>早速その<code>CvEventManager.py</code>がどこにあるのか&hellip;を見ていく前に、<br>
PythonのModdingをしていくにあたって<code>CivilizationIV.ini</code>を編集しましょう。<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
<span style="color:#75715e">; Enable the logging system</span>
<span style="color:#75715e">; Documents\My Games\Beyond the Sword(J)\Logs</span>
<span style="color:#a6e22e">LoggingEnabled</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>

<span style="color:#75715e">; Enable synchronization logging</span>
<span style="color:#a6e22e">SynchLog</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>

<span style="color:#75715e">; Overwrite old network and message logs</span>
<span style="color:#a6e22e">OverwriteLogs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1</span>
<span style="color:#a6e22e">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
</code></pre></div><p>とりあえずこの３つを<code>0</code>から<code>1</code>に変えておきましょう。</p>
<h1 id="cveventinterfacepy">CvEventInterface.py</h1>
<p>さて、<code>CvEventManager.py</code>&hellip;といいたいところなのですが、後々のことまで考えると、<br>
もうちょっと準備が必要です。<br>
そこで、<code>CvEventManagerInterface.py</code>を編集します。</p>
<p>さっそくBtSの元ファイル</p>
<p class="path">
  C:\Program Files (x86)\CYBERFRONT\Sid Meier's Civilization 4(J)\Beyond the Sword(J)\Assets\Python\EntryPoints\CvEventManagerInterface.py
</p>

<p>…はなかったので</p>
<p class="path">
  C:\Program Files (x86)\CYBERFRONT\Sid Meier's Civilization 4(J)\Assets\Python\EntryPoints\CvEventInterface.py
</p>

<p><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>をみると、こうなっていました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Sid Meier&#39;s Civilization 4</span>
<span style="color:#75715e"># Copyright Firaxis Games 2005</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># CvEventInterface.py</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># These functions are App Entry Points from C++</span>
<span style="color:#75715e"># WARNING: These function names should not be changed</span>
<span style="color:#75715e"># WARNING: These functions can not be placed into a class</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># No other modules should import this</span>
<span style="color:#75715e">#</span>
<span style="color:#f92672">import</span> CvUtil
<span style="color:#f92672">import</span> CvEventManager
<span style="color:#f92672">from</span> CvPythonExtensions <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

normalEventManager <span style="color:#f92672">=</span> CvEventManager<span style="color:#f92672">.</span>CvEventManager()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getEventManager</span>():
	<span style="color:#66d9ef">return</span> normalEventManager

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onEvent</span>(argsList):
	<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Called when a game event happens - return 1 if the event was consumed</span><span style="color:#e6db74">&#39;</span>
	<span style="color:#66d9ef">return</span> getEventManager()<span style="color:#f92672">.</span>handleEvent(argsList)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">applyEvent</span>(argsList):
	context, playerID, netUserData, popupReturn <span style="color:#f92672">=</span> argsList
	<span style="color:#66d9ef">return</span> getEventManager()<span style="color:#f92672">.</span>applyEvent(argsList)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">beginEvent</span>(context, argsList<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):
	<span style="color:#66d9ef">return</span> getEventManager()<span style="color:#f92672">.</span>beginEvent(context, argsList)

</code></pre></div><p>これを<strong>どのフォルダに入っているかも含めて</strong>コピーしてきて編集すると、該当ファイルが差し変わるのでした。<br>
<strong>MODフォルダ</strong>に新しく<span class="path">
  kujira\Assets\Python\EntryPoints\
</span>
フォルダを作って、そこにコピーします。</p>
<p>MOD開発中に使用するMODフォルダはユーザーの&quot;Documents&quot;にある方をおすすめします。</p>
<p>パッケージ版の場合</p>
<p class="path">
  ドキュメント\My Games\Beyond the Sword (J)\Mods
</p>

<p>Steam版の場合</p>
<p class="path">
  ドキュメント\My Games\Beyond the Sword\Mods
</p>

<p>です。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">└─kujira
    └─Assets
        └─Python
            └─Entrypoints
                 └─CvEventInterface.py
</code></pre></div><p>コピーした<code>CvEventInterface.py</code>の中身をすこし編集します&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Sid Meier&#39;s Civilization 4</span>
<span style="color:#75715e"># Copyright Firaxis Games 2005</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># CvEventInterface.py</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># These functions are App Entry Points from C++</span>
<span style="color:#75715e"># WARNING: These function names should not be changed</span>
<span style="color:#75715e"># WARNING: These functions can not be placed into a class</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># No other modules should import this</span>
<span style="color:#75715e">#</span>
<span style="color:#f92672">import</span> CvUtil
<span style="color:#75715e"># ここと</span>
<span style="color:#75715e"># import CvEventManager</span>
<span style="color:#f92672">import</span> KujiraEventManager
<span style="color:#f92672">from</span> CvPythonExtensions <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

<span style="color:#75715e"># ここ</span>
<span style="color:#75715e"># normalEventManager = CvEventManager.CvEventManager()</span>
myEventManager <span style="color:#f92672">=</span> KujiraEventManager<span style="color:#f92672">.</span>MyEventManager()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getEventManager</span>():
	<span style="color:#75715e"># ここも</span>
	<span style="color:#66d9ef">return</span> myEventManager

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onEvent</span>(argsList):
	<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Called when a game event happens - return 1 if the event was consumed</span><span style="color:#e6db74">&#39;</span>
	<span style="color:#66d9ef">return</span> getEventManager()<span style="color:#f92672">.</span>handleEvent(argsList)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">applyEvent</span>(argsList):
	context, playerID, netUserData, popupReturn <span style="color:#f92672">=</span> argsList
	<span style="color:#66d9ef">return</span> getEventManager()<span style="color:#f92672">.</span>applyEvent(argsList)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">beginEvent</span>(context, argsList<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):
	<span style="color:#66d9ef">return</span> getEventManager()<span style="color:#f92672">.</span>beginEvent(context, argsList)
</code></pre></div><!-- `KujiraEventManager`というモジュール(あるいは`KujiraEventManager.py`というファイル)にある`MyEventManager`クラスを指定しています。 -->
<p><code>CvEventManager.py</code>というファイルから<br>
<code>KujiraEventManager.py</code>というファイルに指定を変えています。</p>
<h2 id="本命をつくる">本命をつくる</h2>
<p>まだ指定した先である<code>KujiraEventManager.py</code>というファイルがないので、自分でつくります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">└─kujira
    └─Assets
        └─Python
            │─KujiraEventManager.py
            │
            └─Entrypoints
                 └─CvEventInterface.py
</code></pre></div><p><code>KujiraEventManager.py</code>の中身はこのようにします&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> CvEventManager
<span style="color:#f92672">import</span> CvUtil

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyEventManager</span>(CvEventManager<span style="color:#f92672">.</span>CvEventManager, object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onGameStart</span>(self, argsList):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Called at the start of the game</span><span style="color:#e6db74">&#39;</span>
        super(self<span style="color:#f92672">.</span>__class__, self)<span style="color:#f92672">.</span>onGameStart(argsList)
        <span style="color:#75715e">##########</span>
        <span style="color:#75715e"># ログファイルに出力する</span>
        CvUtil<span style="color:#f92672">.</span>pyPrint(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello, Python!</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><!-- 難し過ぎたのでコメントアウト
こうしてみました。元のCvEventManagerを継承して、
onGameStartメソッドをオーバーライドします。
気持ち的には、ゲーム開始時に割って入って、独自の処理をするイメージです。

Civ4のプログラムはゲームの処理中のとある時点でグローバル関数のonEvent()を呼び出します。
onEvent()はそのままCvEventManager.hundleEvent()を呼び出し、hundleEvent()はargsListに渡ってきた
「どんなイベントか」の情報を解釈してon\*\*\*\*\*\*()にさらに振り分けます。
ここでhundleEvent()を呼び出すレシーバのCvEventManagerのインスタンスをすり替えておくと、
かわりにそちらが呼ばれることになります。そのインスタンスを派生クラスのものにしておけば、
hundleEvent()から振り分けられた各イベントハンドラをオーバーライドすることによって、
各タイミングでの処理ができるようになります。
-->
<h2 id="ためす">ためす</h2>
<p>MODをロードして起動してみましょう。<br>
&hellip;&hellip;&hellip;&hellip;シド星に降り立ってみても、とくにバニラとなにも変わっていません。<br>
それもそのはず、ログファイルに文字列を出力する処理しかまだ書いていません。<br>
それを確認するには、(ゲームをいちど始めたうえで、)<br>
Documents\My Games\Beyond the Sword(J)\Logs<br>
にある<code>PythonDbg.log</code>を開いてみます。<br>
(ファイルがありませんか？見るフォルダが間違っているか、冒頭のini編集ができていない可能性があります。確認してみましょう。)</p>
<p>下に下にスクロールしていくと&hellip;<br>
<a href="https://gforestshade.github.io/kujira/img/pyprint.png"><img src="https://gforestshade.github.io/kujira/img/pyprint.png"  width="572"  /></a>
<br>
ありました。ちゃんと動いているようです！</p>
<h1 id="結局何ができるのか">結局、何ができるのか？</h1>
<p>ともかく、特定のタイミングに割って入って、処理を書くことができるわけですが、<br>
そうなってくると気になるのが</p>
<ul>
<li>どういうタイミングに割って入れるのか？</li>
<li>何ができるのか？</li>
</ul>
<p>ということですね。<br>
まずどういうタイミングがあるかですが、<a href="http://modiki.civfanatics.com/index.php?title=CvEventManager">たくさんあります。</a><br>
どういうことができるかについては、<a href="http://civ4bug.sourceforge.net/PythonAPI/index.html">さらにたくさんあります。</a><br>
すべてを覚える必要はもちろんありません。わかりやすいような処理から始めて、<br>
自分の手で書いていくことを通して、少しずつ理解していくのがよいです。</p>
<h1 id="結局こつこつとやっていくしかない">結局こつこつとやっていくしかない</h1>
<p>というわけで、<code>KujiraEventManager.py</code>をこのように変えてみます&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> CvEventManager
<span style="color:#f92672">import</span> CvUtil

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyEventManager</span>(CvEventManager<span style="color:#f92672">.</span>CvEventManager, object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onCityBuilt</span>(self, argsList):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Called when a player builds a city</span><span style="color:#e6db74">&#39;</span>
        super(self<span style="color:#f92672">.</span>__class__, self)<span style="color:#f92672">.</span>onCityBuilt(argsList)
        <span style="color:#75715e">##########</span>
        pCity <span style="color:#f92672">=</span> argsList[<span style="color:#ae81ff">0</span>]
        pCity<span style="color:#f92672">.</span>setPopulation(<span style="color:#ae81ff">4</span>)

</code></pre></div><h2 id="くわしく">くわしく</h2>
<p>捕まえるイベントを、onCityBuiltにしています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;&gt;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onCityBuilt</span>(self, argsList): <span style="color:#75715e">#ここと</span>
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Called when a player builds a city</span><span style="color:#e6db74">&#39;</span> <span style="color:#75715e">#これは特に意味のない飾り</span>
        super(self<span style="color:#f92672">.</span>__class__, self)<span style="color:#f92672">.</span>onCityBuilt(argsList) <span style="color:#75715e">#ここをonCityBuiltにする</span>
<span style="color:#f92672">&lt;&lt;</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#f92672">&lt;&lt;</span>
</code></pre></div><p>独自処理部分では、まず<code>pCity = argsList[0]</code>として<br>
イベントに付随してくる情報を取得しています。<br>
<a href="http://civ4bug.sourceforge.net/PythonAPI/index.html">イベント一覧</a>からdef onCityBuiltをさがしてみると、</p>
<ul>
<li>Function: def onCityBuilt()</li>
<li>Parameters: self, argsList(city)</li>
<li>Description: Called when a player builds a city</li>
</ul>
<p>とあります。「都市を建てたとき」というイベントのようですね。<br>
つまり都市を建てたときに割り込んで何らかのプログラム的処理をしますよ、<br>
という意味になります。</p>
<a href="https://gforestshade.github.io/kujira/img/onCityBuilt.svg"><img src="https://gforestshade.github.io/kujira/img/onCityBuilt.svg"    /></a>

<p>ParametersのargsListのカッコ内にあるのがイベントについてくる情報です。<br>
「ターン開始時」なら、誰のターン開始時で、いま何ターン目なのか、<br>
「プロジェクトが完成したとき」なら、どの都市で、何のプロジェクトが完成したのか、<br>
「ユニットが倒されたとき」なら、それはどのユニットで、またどのユニットに倒されたのか、<br>
等等、そのイベントに関する情報が一緒に送られてくるので、<br>
Pythonではそれらを利用することができます。</p>
<p><code>pCity = argsList[0]</code>に戻ると、<code>argsList</code>の中身に<code>city</code>が入っているはずなので、<br>
それをpCityに取り出しています。<br>
この<code>pCity</code>はイメージとしてはいま立ったばかりの都市そのものが<br>
ぎゅっと詰まっているイメージです。<br>
<code>.</code>(ピリオド)をつけて命令を記述することで<br>
都市の情報を取得したり、都市に操作を加えたりできます。<br>
そこで、<code>pCity.setPopulation(4)</code>として、都市の人口を4にセットしています。</p>
<p>つまりぜんぶまとめて、《都市が建設されたとき、その都市の人口を4にするMOD》ができたことになるはずです。</p>
<h2 id="ためす-1">ためす</h2>
<p>フォルダ構成がこうなっていることを確認して&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">└─kujira
    └─Assets
        └─Python
            │─KujiraEventManager.py
            │
            └─Entrypoints
                 └─CvEventInterface.py
</code></pre></div><p>起動してみると、<br>
<a href="https://gforestshade.github.io/kujira/img/civss_kujira_population_4.png"><img src="https://gforestshade.github.io/kujira/img/civss_kujira_population_4.png"    /></a>
<br>
うまくいきました！</p>
<h1 id="もう少し進める">もう少し進める</h1>
<p>もう一歩進んで、《都市が建設されたとき、その都市に図書館を建設するMOD》を目指してみましょう。</p>
<h2 id="図書館を建設するとは">図書館を建設する、とは</h2>
<p>さて、「図書館を建設する」という「操作」をPythonコードに落とし込みたいです。<br>
探し方はいろいろあります。他人のMODを参考にさせてもらってもよいでしょうし、<br>
civfanaticsで漁るのもよいでしょう。英語でよろしければ、<a href="http://civ4bug.sourceforge.net/PythonAPI/index.html">一覧</a>を載せてくれているWebページもあります。</p>
<p>今回は<a href="http://civ4bug.sourceforge.net/PythonAPI/index.html">リファレンス</a>から探してみましょう。<br>
都市に対する操作なので、最初に<code>CyCity</code>をぽちっと押して、<br>
都市に建物を与えるのですからgetというよりsetでしょうか、<br>
その中からsetで始まっていてBuildingも含んでいるものを探していくと&hellip;<br>
ありました。</p>
<a href="https://gforestshade.github.io/kujira/img/pythonapi_setNumRealBuilding.svg"><img src="https://gforestshade.github.io/kujira/img/pythonapi_setNumRealBuilding.svg"    /></a>

<blockquote>
</blockquote>
<pre><code class="language-nohighlight" data-lang="nohighlight">400. VOID setNumRealBuilding (BuildingType iIndex, INT iNewValue)
(BuildingID, iNum) - Sets number of buildings in this city of BuildingID type
</code></pre><p>建物の種類と、数値を指定して、その建物の数を設定する操作のようです。<br>
数は1でよいのでしょうが、肝心の建物の種類を<br>
どうやって指定するか学ばないといけないようです。</p>
<p>そこで、<code>BuildingType iIndex</code>とあるところに注目します。<br>
iはXMLの編集でおなじみのように数値を表します。<br>
ですから、ここには図書館を表す数値を指定しなければなりません。<br>
が、そんな数値はもちろん知りません。そこで調べて&hellip;くるのではなく、<br>
そこはPython自身に計算してもらえばよいのです。</p>
<p>まず、図書館を表す「キー」を用意しましょう。<br>
(これはどうにかして調べてください。<br>
XML編集をしていた方なら、さほど難しくないと思います)<br>
調べたところ、<code>BUILDING_LIBRARY</code>でした。<br>
そこで<code>gc.getInfoTypeForString('BUILDING_LIBRARY')</code>とすると、<br>
図書館を表す数値を取得できます。<br>
<code>gc</code>を使うのには少し準備がいるので、<br>
それも含めた<code>KujiraEventManager.py</code>のリストはこうなります&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> CvPythonExtensions <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">import</span> CvEventManager
<span style="color:#f92672">import</span> CvUtil

gc <span style="color:#f92672">=</span> CyGlobalContext()

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyEventManager</span>(CvEventManager<span style="color:#f92672">.</span>CvEventManager, object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onCityBuilt</span>(self, argsList):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Called when a player builds a city</span><span style="color:#e6db74">&#39;</span>
        super(self<span style="color:#f92672">.</span>__class__, self)<span style="color:#f92672">.</span>onCityBuilt(argsList)
        <span style="color:#75715e">##########</span>
        pCity <span style="color:#f92672">=</span> argsList[<span style="color:#ae81ff">0</span>]
        iLib <span style="color:#f92672">=</span> gc<span style="color:#f92672">.</span>getInfoTypeString(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">BUILDING_LIBRARY</span><span style="color:#e6db74">&#39;</span>)
        pCity<span style="color:#f92672">.</span>setNumRealBuilding(iLib, <span style="color:#ae81ff">1</span>)

<span style="color:#75715e"># Something is wrong!</span>
</code></pre></div><h2 id="まちがえた">まちがえた？</h2>
<p>さてこれで起動してみます。</p>
<p>&hellip;&hellip;&hellip;しかし都市を覗いてみても、図書館は建っていないようです。</p>
<p>どこかでミスっているのでしょうか。エラーを起こしたなら起こしたで<br>
どの行で起こしたかの場所を知りたいものです。<br>
このようなときDocuments\My Games\Beyond the Sword(J)\Logsにある<br>
<code>PythonErr.log</code>が助けになってくれます。開いてみてみましょう&hellip;</p>
<blockquote>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">Traceback (most recent call last):

  File &#34;CvEventInterface&#34;, line 25, in onEvent

  File &#34;CvEventManager&#34;, line 187, in handleEvent

  File &#34;KujiraEventManager&#34;, line 14, in onCityBuilt

AttributeError: &#39;CyGlobalContext&#39; object has no attribute &#39;getInfoTypeString&#39;
ERR: Python function onEvent failed, module CvEventInterface
</code></pre></div><p>エラーが起こっていました。<br>
ファイル名と行番号が並んでいるうちの一番下、この例では<br>
<code>File &quot;KujiraEventManager&quot;, line 14, in onCityBuilt</code>が<br>
エラーを起こした場所を示してくれています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;&gt;</span>
        iLib <span style="color:#f92672">=</span> gc<span style="color:#f92672">.</span>getInfoTypeString(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">BUILDING_LIBRARY</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&lt;&lt;</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#f92672">&lt;&lt;</span>
</code></pre></div><p>この行ですね。お使いのテキストエディタで行番号の表示ができるのであれば、<br>
すぐ見つかると思います。<br>
エラー内容はこうです。<br>
<code>AttributeError: 'CyGlobalContext' object has no attribute 'getInfoTypeString'</code><br>
「CyGlobalContextのオブジェクトにgetInfoTypeStringなんて属性ないやで」</p>
<p>objectやattributeという単語の意味がいまの時点でわからなくとも、<br>
getInfoTypeStringっていう名前のものがない(探すのに失敗している)<br>
ということはなんとなく感じ取れます。<br>
そして、よくよく見直すと、たしかにgetInfoTypeStringって名前は間違いで、<br>
getInfoTypeForStringが正しいことが分かりました。直しましょう&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> CvPythonExtensions <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">import</span> CvEventManager
<span style="color:#f92672">import</span> CvUtil

gc <span style="color:#f92672">=</span> CyGlobalContext()

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyEventManager</span>(CvEventManager<span style="color:#f92672">.</span>CvEventManager, object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onCityBuilt</span>(self, argsList):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Called when a player builds a city</span><span style="color:#e6db74">&#39;</span>
        super(self<span style="color:#f92672">.</span>__class__, self)<span style="color:#f92672">.</span>onCityBuilt(argsList)
        <span style="color:#75715e">##########</span>
        pCity <span style="color:#f92672">=</span> argsList[<span style="color:#ae81ff">0</span>]
        iLib <span style="color:#f92672">=</span> gc<span style="color:#f92672">.</span>getInfoTypeForString(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">BUILDING_LIBRARY</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e">#typo!</span>
        pCity<span style="color:#f92672">.</span>setNumRealBuilding(iLib, <span style="color:#ae81ff">1</span>)

</code></pre></div><h2 id="ためす-2">ためす</h2>
<p>起動してみて&hellip;<br>
<a href="https://gforestshade.github.io/kujira/img/civss_library.png"><img src="https://gforestshade.github.io/kujira/img/civss_library.png"    /></a>
<br>
動きました！</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Windows10,パッケージ版の場合,<span class="path">
  ドキュメント\My Games\Beyond the Sword(J)
</span>
<br>Steam版の場合,<span class="path">
  ドキュメント\My Games\Beyond the Sword
</span>
にあります <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>パッケージ版の場合。Steam版の場合は<span class="path">
  C:\\Program Files (x86)\\Steam\\SteamApps\\common\\Sid Meier's Civilization IV Beyond the Sword\\Beyond the Sword\\Assets\\Python\\EntryPoints\\CvEventInterface.py
</span>
 <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>
        </div>
        <div class="col-12">
  
</div>

      </div>

    </div>
  </div>

<footer id="contentinfo" class="footer">
  <address id="about" class="vcard body ml-2">
     <a href="https://gforestshade.github.io/kujira/">Kujira, Civ4 Mod Blog</a>  &copy; 2020 gforest_shade; licenced by <a href="https://creativecommons.org/licenses/by/4.0/deed.ja">CC-BY-4.0</a>
  </address>
</footer>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>

